import 'package:apphud/apphud.dart';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:get/get.dart';import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'dart:async';
import 'package:get/get_rx/get_rx.dart';
import 'package:vumbler_cards/game_utils/vumbler_coins.dart';
import 'package:vumbler_cards/game_utils/vumbler_storage.dart';
import 'package:vumbler_cards/game_utils/vumbler_textures.dart';
import 'package:vumbler_cards/vumbler_models.dart/vumbler_shop.dart';

class ShopVumbFrame extends StatefulWidget {
  const ShopVumbFrame({super.key});

  @override
  State<ShopVumbFrame> createState() => _ShopVumbFrameState();
}

class _ShopVumbFrameState extends State<ShopVumbFrame> {
  RxBool vumbPurch = false.obs;
  RxInt vumbSelected =
      (VumblerStorage.vumblerStorage!.getInt('vumbSel') ?? 0).obs;
  final vumbShop = [
    VumblerShop(
      vumblerName: 'default',
      vumblerPath: 'cassets/shop/default.png',
      vumblerPrice: '',
      haveVumbler: true,
      isForBuyVumbler: false,
    ),
    VumblerShop(
      vumblerName: 'tech',
      vumblerPath: 'cassets/shop/tech.png',
      vumblerPrice: '100',
      haveVumbler: (VumblerStorage.vumblerStorage!.getBool('tech') ?? false),
      isForBuyVumbler: false,
    ),
    VumblerShop(
      vumblerName: 'cosmo',
      vumblerPath: 'cassets/shop/cosmo.png',
      vumblerPrice: '150',
      haveVumbler: (VumblerStorage.vumblerStorage!.getBool('cosmo') ?? false),
      isForBuyVumbler: false,
    ),
    VumblerShop(
      vumblerName: 'north',
      vumblerPath: 'cassets/shop/north.png',
      vumblerPrice: '200',
      haveVumbler: (VumblerStorage.vumblerStorage!.getBool('north') ?? false),
      isForBuyVumbler: false,
    ),
    VumblerShop(
      vumblerName: 'fractal',
      vumblerPath: 'cassets/shop/fractal.png',
      vumblerPrice: '300',
      haveVumbler: (VumblerStorage.vumblerStorage!.getBool('fractal') ?? false),
      isForBuyVumbler: false,
    ),
    VumblerShop(
      vumblerName: 'ice',
      vumblerPath: 'cassets/shop/ice.png',
      vumblerPrice: '1.99\$',
      haveVumbler: (VumblerStorage.vumblerStorage!.getBool('ice') ?? false),
      isForBuyVumbler: true,
    ),
  ];

  @override
  Widget build(BuildContext context) {
    return Container(
      decoration: BoxDecoration(
        image: DecorationImage(
            image: AssetImage('cassets/frames/shop.png'), fit: BoxFit.fill),
      ),
      child: Scaffold(
        backgroundColor: Colors.transparent,
        body: Container(
          width: double.infinity,
          child: SafeArea(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                SizedBox(
                  height: 22 / VumblerTextures.vumbZoom,
                ),
                Padding(
                  padding: EdgeInsets.symmetric(
                      horizontal: 28 / VumblerTextures.vumbZoom),
                  child: Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      GestureDetector(
                        onTap: Get.back,
                        child: Image.asset(
                          'cassets/buttons/back_circle.png',
                          height: 40 / VumblerTextures.vumbZoom,
                        ),
                      ),
                      Text(
                        'SHOP',
                        style: TextStyle(
                          fontSize: 40 / VumblerTextures.vumbZoom,
                          fontWeight: FontWeight.w700,
                          color: Colors.white,
                        ),
                      ),
                      Opacity(
                        opacity: 0,
                        child: Image.asset(
                          'cassets/buttons/back_circle.png',
                          height: 40 / VumblerTextures.vumbZoom,
                        ),
                      ),
                    ],
                  ),
                ),
                SizedBox(
                  height: 35 / VumblerTextures.vumbZoom,
                ),
                Expanded(
                  child: ListView.separated(
                    padding: EdgeInsets.only(
                        top: 18 / VumblerTextures.vumbZoom,
                        bottom: 12 / VumblerTextures.vumbZoom),
                    itemCount: vumbShop.length,
                    itemBuilder: (context, index) => Container(
                      height: (377 + 50) / VumblerTextures.vumbZoom,
                      margin: EdgeInsets.symmetric(
                          horizontal: 31 / VumblerTextures.vumbZoom),
                      child: Stack(
                        clipBehavior: Clip.none,
                        alignment: Alignment.center,
                        children: [
                          Positioned(
                            top: -17 / VumblerTextures.vumbZoom,
                            child: Stack(
                              clipBehavior: Clip.none,
                              alignment: Alignment.center,
                              children: [
                                Image.asset(
                                  'cassets/frames/header.png',
                                  height: 49 / VumblerTextures.vumbZoom,
                                ),
                                Padding(
                                  padding: EdgeInsets.only(
                                      bottom: 3.0 / VumblerTextures.vumbZoom),
                                  child: Text(
                                    vumbShop[index].vumblerName.toUpperCase(),
                                    style: TextStyle(
                                        fontSize: 16 / VumblerTextures.vumbZoom,
                                        fontWeight: FontWeight.w700,
                                        color: Colors.white),
                                  ),
                                )
                              ],
                            ),
                          ),
                          Stack(
                            alignment: Alignment.center,
                            clipBehavior: Clip.none,
                            children: [
                              Image.asset(
                                vumbShop[index].vumblerPath,
                                height: 377 / VumblerTextures.vumbZoom,
                              ),
                            ],
                          ),
                          Positioned(
                            bottom: 3,
                            child: GestureDetector(
                              onTap: () async {
                                if (vumbShop[index].haveVumbler) {
                                  if (vumbSelected.value != index) {
                                    vumbSelected.value = index;
                                    setState(() {});
                                    VumblerStorage.vumblerStorage!
                                        .setInt('vumbSel', vumbSelected.value);
                                  }
                                } else {
                                  if (vumbShop[index].isForBuyVumbler) {
                                    // PURCHASE
                                    if (!vumbPurch.value) {
                                      vumbPurch.value = true;
                                      setState(() {});
                                      final vumbspw = await Apphud.paywalls();
                                      print(vumbspw?.paywalls.first.products!);
                                      final vaultstv = await Apphud.purchase(
                                        product: vumbspw
                                            ?.paywalls.first.products!
                                            .where((bartvbartv) =>
                                                bartvbartv.productId ==
                                                'ice_card')
                                            .toList()
                                            .first,
                                      );
                                      if (vaultstv.error == null) {
                                        vumbShop[index].haveVumbler = true;
                                        VumblerStorage.vumblerStorage!.setBool(
                                            vumbShop[index].vumblerName, true);
                                        setState(() {});
                                      }

                                      vumbPurch.value = false;
                                      setState(() {});
                                    }
                                  } else {
                                    if (int.parse(
                                            vumbShop[index].vumblerPrice) <=
                                        VumblerCoins.vumblerCoins.value) {
                                      vumbShop[index].haveVumbler = true;
                                      VumblerCoins.plusMinusCoins(-int.parse(
                                          vumbShop[index].vumblerPrice));
                                      setState(() {});
                                      VumblerStorage.vumblerStorage!.setBool(
                                          vumbShop[index].vumblerName, true);
                                    }
                                  }
                                }
                              },
                              child: Stack(
                                alignment: Alignment.center,
                                children: [
                                  Obx(
                                    () {
                                      return Image.asset(
                                        vumbSelected.value == index
                                            ? 'cassets/buttons/selected.png'
                                            : vumbShop[index].haveVumbler
                                                ? 'cassets/buttons/select.png'
                                                : !vumbShop[index]
                                                            .vumblerPrice
                                                            .contains('.') &&
                                                        int.parse(vumbShop[
                                                                    index]
                                                                .vumblerPrice) >
                                                            VumblerCoins
                                                                .vumblerCoins
                                                                .value
                                                    ? 'cassets/buttons/gray_empty.png'
                                                    : 'cassets/buttons/empty.png',
                                        height: 52 / VumblerTextures.vumbZoom,
                                      );
                                    },
                                  ),
                                  if (!vumbShop[index].haveVumbler)
                                    if (vumbPurch.value &&
                                        vumbShop[index].isForBuyVumbler)
                                      CupertinoActivityIndicator(
                                        color: Colors.white,
                                      )
                                    else
                                      Row(
                                        mainAxisAlignment:
                                            MainAxisAlignment.center,
                                        children: [
                                          Text(
                                            'BUY',
                                            style: TextStyle(
                                                fontSize: 14 /
                                                    VumblerTextures.vumbZoom,
                                                fontWeight: FontWeight.w700,
                                                color: Colors.white),
                                          ),
                                          SizedBox(
                                            width: 8 / VumblerTextures.vumbZoom,
                                          ),
                                          if (!vumbShop[index].isForBuyVumbler)
                                            Image.asset(
                                              'cassets/buttons/money.png',
                                              height:
                                                  18 / VumblerTextures.vumbZoom,
                                            ),
                                          if (!vumbShop[index].isForBuyVumbler)
                                            SizedBox(
                                              width:
                                                  8 / VumblerTextures.vumbZoom,
                                            ),
                                          Text(
                                            vumbShop[index].vumblerPrice,
                                            style: TextStyle(
                                                fontSize: 14 /
                                                    VumblerTextures.vumbZoom,
                                                fontWeight: FontWeight.w700,
                                                color: Colors.white),
                                          ),
                                        ],
                                      ),
                                ],
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                    separatorBuilder: (context, index) => SizedBox(
                      height: 52 / VumblerTextures.vumbZoom,
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}
